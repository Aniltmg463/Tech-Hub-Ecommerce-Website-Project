@startuml User_Authentication_Sequence

title TechHub E-Commerce - User Authentication Flow

actor User
participant "Login Page" as UI
participant "Auth Context" as Context
participant "Axios Client" as Axios
participant "Auth Routes" as Routes
participant "Auth Middleware" as Middleware
participant "Auth Controller" as Controller
participant "Auth Helper" as Helper
database "MongoDB" as DB

User -> UI: Enter email & password
activate UI

UI -> UI: Validate input format
UI -> Axios: POST /api/v1/auth/login\n{email, password}
activate Axios

Axios -> Routes: HTTP Request
activate Routes

Routes -> Controller: loginController(req, res)
activate Controller

Controller -> DB: Find user by email
activate DB
DB --> Controller: User document
deactivate DB

alt User not found
    Controller --> Routes: Error: "Email not registered"
    Routes --> Axios: 404 Not Found
    Axios --> UI: Display error
    UI --> User: Show error message
else User found
    Controller -> Helper: comparePassword(plain, hashed)
    activate Helper
    Helper -> Helper: bcrypt.compare()
    Helper --> Controller: true/false
    deactivate Helper

    alt Password incorrect
        Controller --> Routes: Error: "Invalid password"
        Routes --> Axios: 401 Unauthorized
        Axios --> UI: Display error
        UI --> User: Show error message
    else Password correct
        Controller -> Helper: generateToken(user)
        activate Helper
        Helper -> Helper: jwt.sign(payload, secret)
        Helper --> Controller: JWT token
        deactivate Helper

        Controller --> Routes: Success: {token, user}
        deactivate Controller
        Routes --> Axios: 200 OK
        deactivate Routes
        Axios --> UI: {token, user}
        deactivate Axios

        UI -> Context: setAuth({token, user})
        activate Context
        Context -> Context: Store in localStorage
        Context -> Axios: Set Authorization header
        Context --> UI: Auth updated
        deactivate Context

        UI --> User: Redirect to dashboard
        deactivate UI
    end
end

note right of Helper
  **JWT Token Contains:**
  - user_id
  - email
  - role
  - expiration time
end note

note right of Context
  **Auth Context Actions:**
  1. Store token in state
  2. Save to localStorage
  3. Update Axios defaults
  4. Trigger re-render
end note

@enduml

@startuml Product_Purchase_Sequence

title TechHub E-Commerce - Product Purchase Flow

actor User
participant "Cart Page" as Cart
participant "Braintree UI" as BraintreeUI
participant "Cart Context" as CartContext
participant "Axios Client" as Axios
participant "Product Routes" as Routes
participant "Product Controller" as Controller
participant "Braintree Gateway" as Braintree
participant "Order Controller" as OrderCtrl
database "MongoDB" as DB

User -> Cart: Click "Proceed to Checkout"
activate Cart

Cart -> Axios: GET /api/v1/product/braintree/token
activate Axios
Axios -> Routes: Request token
activate Routes
Routes -> Controller: braintreeTokenController()
activate Controller
Controller -> Braintree: gateway.clientToken.generate()
activate Braintree
Braintree --> Controller: Client token
deactivate Braintree
Controller --> Routes: {clientToken}
deactivate Controller
Routes --> Axios: 200 OK
deactivate Routes
Axios --> Cart: Client token
deactivate Axios

Cart -> BraintreeUI: Initialize Drop-in UI\nwith client token
activate BraintreeUI
BraintreeUI --> User: Show payment form
deactivate BraintreeUI

User -> BraintreeUI: Enter payment details
activate BraintreeUI
BraintreeUI -> BraintreeUI: Validate card info
BraintreeUI --> User: Show "Pay" button
deactivate BraintreeUI

User -> BraintreeUI: Click "Pay"
activate BraintreeUI
BraintreeUI -> BraintreeUI: Create payment nonce
BraintreeUI --> Cart: {nonce, cardType}
deactivate BraintreeUI

Cart -> Axios: POST /api/v1/product/braintree/payment\n{nonce, cart}
activate Axios
Axios -> Routes: Payment request
activate Routes
Routes -> Controller: brainTreePaymentController()
activate Controller

Controller -> Controller: Calculate total amount
Controller -> Braintree: gateway.transaction.sale({\n  amount, nonce})
activate Braintree

alt Payment Declined
    Braintree --> Controller: Error: Payment failed
    Controller --> Routes: Error response
    Routes --> Axios: 500 Error
    Axios --> Cart: Payment failed
    Cart --> User: Show error message
else Payment Successful
    Braintree --> Controller: {success: true,\n  transaction}
    deactivate Braintree

    Controller -> DB: Create Order document
    activate DB
    DB --> Controller: Order created
    deactivate DB

    Controller -> DB: Update product quantities
    activate DB
    DB --> Controller: Stock updated
    deactivate DB

    Controller --> Routes: Success: {order}
    deactivate Controller
    Routes --> Axios: 200 OK
    deactivate Routes
    Axios --> Cart: Order confirmation
    deactivate Axios

    Cart -> CartContext: Clear cart
    activate CartContext
    CartContext -> CartContext: Remove from localStorage
    CartContext --> Cart: Cart cleared
    deactivate CartContext

    Cart --> User: Show success message\nOrder ID: #12345
    deactivate Cart
end

note right of Braintree
  **Payment Processing:**
  1. Validate payment method
  2. Authorize transaction
  3. Capture funds
  4. Return transaction ID
end note

note right of Controller
  **Order Creation Steps:**
  1. Validate cart items
  2. Check stock availability
  3. Calculate total
  4. Process payment
  5. Create order record
  6. Update inventory
  7. Send confirmation
end note

@enduml

@startuml Product_Recommendation_Sequence

title TechHub E-Commerce - Product Recommendation Flow (Jaccard Algorithm)

actor User
participant "Product Page" as UI
participant "Axios Client" as Axios
participant "Product Routes" as Routes
participant "Product Controller" as Controller
participant "Jaccard Helper" as Jaccard
database "MongoDB" as DB

User -> UI: View product details
activate UI

UI -> UI: Display product info
UI -> Axios: GET /api/v1/product/related/:pid/:cid
activate Axios

Axios -> Routes: Request related products
activate Routes

Routes -> Controller: relatedProductController(pid, cid)
activate Controller

Controller -> DB: Find current product by ID
activate DB
DB --> Controller: Current product\n{keywords: ["laptop", "gaming", "rgb"]}
deactivate DB

Controller -> DB: Find all products\nin same category (cid)
activate DB
DB --> Controller: Array of products\nin category
deactivate DB

Controller -> Controller: Exclude current product
Controller -> Controller: Loop through each product

loop For each product in category
    Controller -> Jaccard: calculateSimilarity(\n  currentKeywords,\n  productKeywords)
    activate Jaccard

    Jaccard -> Jaccard: tokenize(keywords)
    note right of Jaccard
      **Jaccard Algorithm:**
      J(A,B) = |A ∩ B| / |A ∪ B|

      Example:
      A = ["laptop", "gaming", "rgb"]
      B = ["laptop", "gaming", "portable"]

      A ∩ B = ["laptop", "gaming"] = 2
      A ∪ B = ["laptop", "gaming", "rgb", "portable"] = 4

      J(A,B) = 2/4 = 0.5 (50% similarity)
    end note

    Jaccard -> Jaccard: Calculate intersection (A ∩ B)
    Jaccard -> Jaccard: Calculate union (A ∪ B)
    Jaccard -> Jaccard: J(A,B) = |intersection| / |union|

    Jaccard --> Controller: Similarity score (0.0 - 1.0)
    deactivate Jaccard

    Controller -> Controller: Store {product, score}
end

Controller -> Controller: Sort by score (descending)
Controller -> Controller: Take top 3 products
Controller -> Controller: Exclude photo data\n(reduce payload size)

Controller --> Routes: Array of related products
deactivate Controller
Routes --> Axios: 200 OK\n[{product1, score: 0.8},\n {product2, score: 0.6},\n {product3, score: 0.5}]
deactivate Routes
Axios --> UI: Related products
deactivate Axios

UI -> UI: Render "Related Products"\nsection

UI --> User: Display 3 similar products
deactivate UI

note right of Controller
  **Optimization:**
  - Limit to top 3 results
  - Exclude photo Buffer
  - Cache results (optional)
  - Only same category
end note

@enduml

@startuml Admin_Product_Creation_Sequence

title TechHub E-Commerce - Admin Product Creation Flow

actor Admin
participant "Create Product\nPage" as UI
participant "Axios Client" as Axios
participant "JWT Middleware" as JWTMiddle
participant "Admin Middleware" as AdminMiddle
participant "File Upload\nMiddleware" as FileMiddle
participant "Product Controller" as Controller
participant "Jaccard Helper" as Jaccard
database "MongoDB" as DB

Admin -> UI: Fill product form\n& upload image
activate UI

UI -> UI: Validate form data
UI -> Axios: POST /api/v1/product/create-product\nFormData {name, description,\n price, quantity, photo, category}
activate Axios

note right of Axios
  **FormData includes:**
  - Text fields (name, desc, price)
  - File (photo)
  - Uses multipart/form-data
end note

Axios -> JWTMiddle: Request with JWT token\nin Authorization header
activate JWTMiddle

JWTMiddle -> JWTMiddle: Verify JWT token
alt Invalid token
    JWTMiddle --> Axios: 401 Unauthorized
    Axios --> UI: Authentication error
    UI --> Admin: Redirect to login
else Valid token
    JWTMiddle -> JWTMiddle: Decode user from token
    JWTMiddle -> AdminMiddle: Next() with req.user
    deactivate JWTMiddle
    activate AdminMiddle

    AdminMiddle -> AdminMiddle: Check req.user.role
    alt role != 1 (not admin)
        AdminMiddle --> Axios: 403 Forbidden
        Axios --> UI: Authorization error
        UI --> Admin: Show "Unauthorized" error
    else role == 1 (is admin)
        AdminMiddle -> FileMiddle: Next()
        deactivate AdminMiddle
        activate FileMiddle

        FileMiddle -> FileMiddle: Parse FormData\nusing Formidable
        FileMiddle -> FileMiddle: Extract fields\nand files

        alt File size > limit
            FileMiddle --> Axios: 400 Bad Request\n"Photo size too large"
            Axios --> UI: Validation error
            UI --> Admin: Show error message
        else File size OK
            FileMiddle -> Controller: createProductController()\nreq.fields, req.files
            deactivate FileMiddle
            activate Controller

            Controller -> Controller: Validate required fields
            Controller -> Controller: Read photo file\nto Buffer

            alt Validation fails
                Controller --> Axios: 400 Bad Request
                Axios --> UI: Validation errors
                UI --> Admin: Show field errors
            else Validation passes
                Controller -> Jaccard: generateKeywords(\n  name, description)
                activate Jaccard
                Jaccard -> Jaccard: Tokenize text
                Jaccard -> Jaccard: Remove stop words
                Jaccard -> Jaccard: Extract top keywords
                Jaccard --> Controller: keywords array
                deactivate Jaccard

                Controller -> Controller: Create product object\n{...fields, photo: Buffer,\n keywords: [...]}

                Controller -> DB: Save product
                activate DB
                DB --> Controller: Product created
                deactivate DB

                Controller --> Axios: 201 Created\n{product}
                deactivate Controller
                Axios --> UI: Success response
                deactivate Axios

                UI -> UI: Clear form
                UI --> Admin: Show success message\n"Product created successfully"
                deactivate UI
            end
        end
    end
end

note right of FileMiddle
  **File Upload Handling:**
  - Max size: 1MB
  - Allowed: image/*
  - Stored as Buffer in DB
  - Parsed by Formidable
end note

note right of Controller
  **Product Creation:**
  1. Validate all fields
  2. Generate keywords
  3. Process photo to Buffer
  4. Create slug from name
  5. Save to database
  6. Return created product
end note

@enduml

@startuml User_Registration_Sequence

title TechHub E-Commerce - User Registration Flow

actor User
participant "Register Page" as UI
participant "Axios Client" as Axios
participant "Auth Routes" as Routes
participant "Auth Controller" as Controller
participant "Auth Helper" as Helper
database "MongoDB" as DB

User -> UI: Fill registration form
activate UI

UI -> UI: Validate form\n(email format, password strength)

UI -> Axios: POST /api/v1/auth/register\n{name, email, password,\n phone, address, answer}
activate Axios

Axios -> Routes: Registration request
activate Routes

Routes -> Controller: registerController(req, res)
activate Controller

Controller -> DB: Check if email exists
activate DB
DB --> Controller: Query result
deactivate DB

alt Email already registered
    Controller --> Routes: Error: "Email already registered"
    Routes --> Axios: 400 Bad Request
    Axios --> UI: Registration failed
    UI --> User: Show error message
else Email available
    Controller -> Helper: hashPassword(password)
    activate Helper
    Helper -> Helper: bcrypt.hash(password, 10)
    note right of Helper
      **Password Hashing:**
      - Algorithm: bcrypt
      - Salt rounds: 10
      - Output: Hashed string
      - One-way encryption
    end note
    Helper --> Controller: Hashed password
    deactivate Helper

    Controller -> Controller: Create user object\n{...fields, password: hashed}

    Controller -> DB: Create new user
    activate DB
    DB --> Controller: User saved
    deactivate DB

    Controller --> Routes: Success: {user}\n(password excluded)
    deactivate Controller
    Routes --> Axios: 201 Created
    deactivate Routes
    Axios --> UI: Registration successful
    deactivate Axios

    UI --> User: Show success message\n"Account created! Please login"
    UI -> UI: Redirect to login page
    deactivate UI
end

@enduml
